
/**
 * @file SEMS - Firestore Security Rules
 * @description This ruleset enforces a role-based access control model for the SEMS application.
 *
 * Data Structure:
 * - /sports/{sportId}: Public data about sports.
 * - /venues/{venueId}: Public data about venues.
 * - /departments/{departmentId}: Data about university departments.
 * - /events/{eventId}: Public data about events.
 * - /events/{eventId}/teams/{teamId}: Data about teams participating in events.
 * - /events/{eventId}/matches/{matchId}: Data about matches scheduled for events.
 * - /users/{userId}: Private user profile data.
 * - /userProfiles/{userId}: Temporary profile data for new users.
 * - /events/{eventId}/logs/{logId}: Log entries for events.
 * - /brackets/{eventId}: Tournament bracket data for an event.
 * - /settings/{settingId}: Global application settings.
 *
 * Key Security Decisions:
 * - Super Admin (sems.cust@outlook.com) has full CRUD access to all data.
 * - Admins can manage sports, venues, departments, events, and student user accounts. They cannot manage other admin accounts.
 * - Students can read public data and manage their own profiles.
 *
 * Access Control Patterns:
 * - Sports, Venues, Departments, Events, Brackets: Public read, admin/super-admin write.
 * - Teams, Matches: Event-scoped access.
 * - Users: Owner-only access for read/write. Admins can manage students. Super Admin can manage anyone except themselves.
 * - UserProfiles: Admin/Super Admin can create. Owner can read and delete.
 * - Settings: Admin/Super-Admin can read. Super-Admin can write.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }
    
    function getRequestingUserData() {
        return getUserData(request.auth.uid);
    }

    function isSuperAdmin(userId) {
      return getUserData(userId).email == 'sems.cust@outlook.com';
    }
    
    function isRequestingUserSuperAdmin() {
        return isSignedIn() && getRequestingUserData().email == 'sems.cust@outlook.com';
    }

    function isRequestingUserAdmin() {
      return isSignedIn() && getRequestingUserData().role == 'admin';
    }

    function isRoleChangeOnSuperAdmin(userId) {
        return isSuperAdmin(userId) && request.resource.data.role != resource.data.role;
    }

    match /sports/{sportId} {
      allow get, list: if true;
      allow create, update, delete: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();
    }

    match /venues/{venueId} {
      allow get, list: if true;
      allow create, update, delete: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();
    }

    match /departments/{departmentId} {
      allow get, list: if true;
      allow create, update, delete: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();
    }
    
    match /settings/{settingId} {
      allow get, list: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();
      allow create, update, delete: if isRequestingUserSuperAdmin();
    }

    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();

      match /joinRequests/{userId} {
        allow list: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();
        allow get: if isRequestingUserAdmin() || isRequestingUserSuperAdmin() || isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();
        allow delete: if false;
      }
      
      match /teams/{teamId} {
        allow get, list: if true;
        allow create, update, delete: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();
      }

      match /matches/{matchId} {
        allow get, list: if true;
        allow create, update, delete: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();
      }

       match /logs/{logId} {
        allow get, list: if true;
        allow create, update, delete: if false;
       }
    }

    match /brackets/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if isRequestingUserAdmin() || isRequestingUserSuperAdmin();
    }

    match /users/{userId} {
      // Super admin can read anyone. Admins can read students. Users can read themselves.
      allow get: if isRequestingUserSuperAdmin() || (isRequestingUserAdmin() && getUserData(userId).role == 'student') || isOwner(userId);
      // Only super admin and admins can list users. (Further filtering on client-side)
      allow list: if isRequestingUserSuperAdmin() || isRequestingUserAdmin();
      // Super admin can create anyone. Admins can create students. Users can create their own doc.
      allow create: if isRequestingUserSuperAdmin() || (isRequestingUserAdmin() && request.resource.data.role == 'student') || isOwner(userId);
      // Super admin can update anyone but themselves. Admins can only update students. Owners can update themselves.
      allow update: if (isRequestingUserSuperAdmin() && !isSuperAdmin(userId)) || (isRequestingUserAdmin() && resource.data.role == 'student' && request.resource.data.role == 'student') || isOwner(userId);
      // Super admin can delete anyone but themselves. Admins can only delete students.
      allow delete: if (isRequestingUserSuperAdmin() && !isSuperAdmin(userId)) || (isRequestingUserAdmin() && resource.data.role == 'student');
    }
    
    match /userProfiles/{userId} {
      allow create: if isSignedIn();
      allow get, delete: if isOwner(userId);
      allow list, update: if false;
    }
  }
}
